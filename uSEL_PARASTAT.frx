ˇçWITH SUMS AS (

select CSTM.HEID , CSTM.HECODE, [CSTM].[HENAME] ,SUM(ISNULL(TRCM.HEEBALANCE,0)) AS YPOL
, [CNTC].[HETIN]

, [TRBR].[HECITY]
, [TRBR].[HEPOSTALCODE], [TRBR].[HEPHONE1]
[TRBRPHONE1], [TRBR].[HEPHONE2] [TRBRPHONE2], [TRBR].[HEPHONE3] [TRBRPHONE3], [TRBR].[HEPHONE4] [TRBRPHONE4], [TRBR].[HEPHONE5] [TRBRPHONE5],
[TRBR].[HEEMAIL] [TRBREMAIL],
   Trbr.heStreet+' '+coalesce(Trbr.heStreetNumber, '') [ADDRESS],
  [HETAXOFFICES].[HENAME] [TFFCNAME], [HEPROFESSIONS].[HENAME]
[PRFSNAME], [HEINDUSTRIES].[HENAME] [IDRSNAME], [HECOUNTRIES].[HENAME] [CNTRNAME],
 [HECOUNTRIES].[HENAME] [DSTTNAME], [HECOUNTRIES].[HENAME] [MNCPNAME], [CATEGORIESCSTM1].[HENAME] [CCSTNAME1],
[CATEGORIESCSTM2].[HENAME] [CCSTNAME2], [TREESCSTM1].[HENAME] [TCSTNAME1], [TREESCSTM2].[HENAME] [TCSTNAME2],
 [CURR].[HECODE] [CURRCODE], [CURR].[HENAME] [CURRNAME], [TRDRACCCAT].[HECODE]
[TRDRACCCATCODE], [TRDRACCCAT].[HENAME] [TRDRACCCATNAME], [WHOLESALEPRCLIST].[HECODE] [WHOLESALEPRCLISTCODE],
[WHOLESALEPRCLIST].[HENAME] [WHOLESALEPRCLISTNAME], [RETAILPRCLIST].[HECODE]
[RETAILPRCLISTCODE], [RETAILPRCLIST].[HENAME] [RETAILPRCLISTNAME], [PAYMENTMETHOD].[HECODE] [PAYMENTMETHODCODE],
 [PAYMENTMETHOD].[HENAME] [PAYMENTMETHODNAME], [ADDCHRGGRP].[HECODE]
[ADDCHRGGRPCODE], [ADDCHRGGRP].[HENAME] [ADDCHRGGRPNAME], [SHIPPINGMETHOD].[HECODE] [SHIPPINGMETHODCODE],
[SHIPPINGMETHOD].[HENAME] [SHIPPINGMETHODNAME], [VATSTS].[HECODE] [VATSTSCODE],
[VATSTS].[HENAME] [VATSTSNAME], [VATEXM].[HECODE] [VATEXMCODE], [VATEXM].[HENAME] [VATEXMNAME],
 [SALESMAN].[HECODE] [SALESMANCODE], [SALESMAN].[HENAME] [SALESMANNAME], [COLLECTOR].[HECODE]
[COLLECTORCODE], [COLLECTOR].[HENAME] [COLLECTORNAME]



from [HECUSTOMERS] [CSTM] WITH(NOLOCK)
inner join [HETRADERS] [TRDR] WITH(NOLOCK)  on ([CSTM].[HETRDRID] = [TRDR].[HEID])
Inner Join
[HECONTACTS] [CNTC] WITH(NOLOCK)  on ([TRDR].[HECNTCID] = [CNTC].[HEID])
inner join [HETRADERBRANCHES] [TRBR] WITH(NOLOCK)  on ([TRBR].[HETRDRID] = [TRDR].[HEID] )
left join [HETAXOFFICES] WITH(NOLOCK)  on ([TRDR].[HETFFCID] = [HETAXOFFICES].[HEID])
left join [HEPROFESSIONS] WITH(NOLOCK)  on ([TRBR].[HEPRFSID] = [HEPROFESSIONS].[HEID])
Left
join [HEINDUSTRIES] WITH(NOLOCK)  on ([TRDR].[HEIDRSID] = [HEINDUSTRIES].[HEID])
left join [HECOUNTRIES] WITH(NOLOCK)  on ([TRBR].[HECNTRID] = [HECOUNTRIES].[HEID])
left join [HEDISTRICTS]
WITH(NOLOCK)  on ([TRBR].[HEDSTTID] = [HEDISTRICTS].[HEID])
left join [HEMUNICIPALITIES] WITH(NOLOCK)  on ([TRBR].[HEMNCPID] = [HEMUNICIPALITIES].[HEID])
left join [HECATEGORIESCSTM] [CATEGORIESCSTM1] WITH(NOLOCK)  on ([CSTM].[HECAT01ID] = [CATEGORIESCSTM1].[HEID])
left join [HECATEGORIESCSTM] [CATEGORIESCSTM2] WITH(NOLOCK)  on ([CSTM].[HECAT02ID] = [CATEGORIESCSTM2].[HEID])
left join [HETREESCSTM] [TREESCSTM1] WITH(NOLOCK)  on ([CSTM].[HETREECAT01ID] = [TREESCSTM1].[HEID])
left join [HETREESCSTM] [TREESCSTM2] WITH(NOLOCK)  on ([CSTM].[HETREECAT02ID] = [TREESCSTM2].[HEID])
inner join [HECURRENCIES] [CURR] WITH(NOLOCK)  on ([CSTM].[HECURRID] = [CURR].[HEID])
left join [HETRDRACCCATEGORIES] [TRDRACCCAT] WITH(NOLOCK)  on ([CSTM].[HETRACID] = [TRDRACCCAT].[HEID])
inner join [HECUSTOMERBRANCHES] [CSBR] WITH(NOLOCK)  on ([TRBR].[HEID] = [CSBR].[HETRBRID] and [CSTM].[HEID] = [CSBR].[HECSTMID])
left join [HEPRICELISTS] [WHOLESALEPRCLIST] WITH(NOLOCK)  on ([CSBR].[HEPRLSID] = [WHOLESALEPRCLIST].[HEID])
left join [HEPRICELISTS] [RETAILPRCLIST] WITH(NOLOCK)  on ([CSBR].[HERETAILPRLSID] = [RETAILPRCLIST].[HEID])
left join [HEPAYMENTMETHODS] [PAYMENTMETHOD] WITH(NOLOCK)  on ([CSBR].[HEPMMTID] = [PAYMENTMETHOD].[HEID])
left join [HEADDDOCCHARGESGROUPS] [ADDCHRGGRP] WITH(NOLOCK)  on ([CSBR].[HEADCGID] = [ADDCHRGGRP].[HEID])
left join [HESHIPPINGMETHODS] [SHIPPINGMETHOD] WITH(NOLOCK)  on ([CSBR].[HESHPMID] = [SHIPPINGMETHOD].[HEID])
left join [HEVATSTATUSES] [VATSTS] WITH(NOLOCK)  on ([CSBR].[HEVTSTID] = [VATSTS].[HEID])
left join [HEVATEXEMPTIONS] [VATEXM] WITH(NOLOCK)  on ([CSBR].[HEVTEXID] = [VATEXM].[HEID])
left join [HEAGENTS] [SALESMAN] WITH(NOLOCK)  on ([CSBR].[HEAGNTID] = [SALESMAN].[HEID])
left join [HEAGENTS] [COLLECTOR] WITH(NOLOCK)  on ([CSBR].[HECOLLAGNTID] = [COLLECTOR].[HEID])
LEFT join [HETRADERACCUMULATORS] [TRCM] WITH(NOLOCK)  on ([CSTM].[HEID] = [TRCM].[HECSTMID] and [TRBR].[HEID] = [TRCM].[HETRBRID])
Where [CSTM].[HEACTIVE] = 1 AND  YEAR(TRCM.HEDATE)=2021

Group By
 CSTM.HEID , [CSTM].[HENAME],
CSTM.HECODE , [CSTM].[HENAME], HETIN

,  [TRBR].[HECITY]
, [TRBR].[HEPOSTALCODE] , [TRBR].[HEPHONE1]
, [TRBR].[HEPHONE2] , [TRBR].[HEPHONE3] , [TRBR].[HEPHONE4] , [TRBR].[HEPHONE5] , [TRBR].[HEEMAIL]  ,
    Trbr.heStreet+' '+coalesce(Trbr.heStreetNumber, ''),
  [HETAXOFFICES].[HENAME] , [HEPROFESSIONS].[HENAME]
, [HEINDUSTRIES].[HENAME] , [HECOUNTRIES].[HENAME] , [HECOUNTRIES].[HENAME] ,
 [HECOUNTRIES].[HENAME] , [CATEGORIESCSTM1].[HENAME] ,
[CATEGORIESCSTM2].[HENAME] , [TREESCSTM1].[HENAME], [TREESCSTM2].[HENAME], [CURR].[HECODE], [CURR].[HENAME], [TRDRACCCAT].[HECODE]
, [TRDRACCCAT].[HENAME] , [WHOLESALEPRCLIST].[HECODE] , [WHOLESALEPRCLIST].[HENAME] , [RETAILPRCLIST].[HECODE]
, [RETAILPRCLIST].[HENAME] , [PAYMENTMETHOD].[HECODE], [PAYMENTMETHOD].[HENAME] , [ADDCHRGGRP].[HECODE]
, [ADDCHRGGRP].[HENAME] , [SHIPPINGMETHOD].[HECODE] , [SHIPPINGMETHOD].[HENAME] , [VATSTS].[HECODE] ,
[VATSTS].[HENAME] , [VATEXM].[HECODE], [VATEXM].[HENAME], [SALESMAN].[HECODE], [SALESMAN].[HENAME], [COLLECTOR].[HECODE]
, [COLLECTOR].[HENAME]

)

SELECT
 HEID,YPOL,
[HENAME],
HECODE , HETIN

,  [HECITY]
,[HEPOSTALCODE] , [TRBRPHONE1]
, [TRBRPHONE2] ,[TRBRPHONE3] , [TRBRPHONE4] , [TRBRPHONE5] ,[TRBREMAIL] ,
   ADDRESS ,
 TFFCNAME , [PRFSNAME]
, [IDRSNAME],   [CNTRNAME],[DSTTNAME],
  [MNCPNAME],   [CCSTNAME1],
[CCSTNAME2] ,
 [TCSTNAME1],  [TCSTNAME2],
  [CURRCODE],  [CURRNAME],
[TRDRACCCATCODE],  [TRDRACCCATNAME],[WHOLESALEPRCLISTCODE],
 [WHOLESALEPRCLISTNAME],
[RETAILPRCLISTCODE],[RETAILPRCLISTNAME],  [PAYMENTMETHODCODE],
  [PAYMENTMETHODNAME],
[ADDCHRGGRPCODE],  [ADDCHRGGRPNAME], [SHIPPINGMETHODCODE],
 [SHIPPINGMETHODNAME],  [VATSTSCODE],
 [VATSTSNAME], [VATEXMCODE],  [VATEXMNAME],
 [SALESMANCODE],  [SALESMANNAME],
[COLLECTORCODE] , [COLLECTORNAME]



 From SUMS

 WHERE YPOL<>0 
 ORDER BY HEID


